<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NivelUPC | Sistema de Control de Nivel de Agua</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --verde-oscuro: #0D7339;
            --verde-medio: #57A641;
            --verde-claro: #94BF75;
            --verde-muy-claro: #E8F5E9;
            --verde-acento: #2E8B57;
            --amarillo: #F2CC0C;
            --amarillo-oscuro: #D4B106;
            --blanco: #FFFFFF;
            --gris-oscuro: #2C3E50;
            --gris-medio: #7F8C8D;
            --gris-claro: #ECF0F1;
            --rojo: #E74C3C;
            --rojo-oscuro: #C0392B;
            --sombra: 0 8px 20px rgba(0, 0, 0, 0.12);
            --sombra-hover: 0 12px 28px rgba(0, 0, 0, 0.15);
            --borde-radius: 16px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--verde-oscuro) 0%, var(--verde-medio) 100%);
            color: var(--gris-oscuro);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Header con logo */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--blanco);
            padding: 25px 30px;
            border-radius: var(--borde-radius) var(--borde-radius) 0 0;
            box-shadow: var(--sombra);
            position: relative;
            overflow: hidden;
            border-bottom: 4px solid var(--verde-oscuro);
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        
        .logo-placeholder {
            width: 65px;
            height: 65px;
            background: linear-gradient(135deg, var(--verde-oscuro) 0%, var(--verde-medio) 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--blanco);
            font-size: 26px;
            box-shadow: 0 4px 10px rgba(13, 115, 57, 0.3);
        }
        
        .logo-text h1 {
            color: var(--verde-oscuro);
            font-size: 1.9em;
            margin-bottom: 5px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        
        .logo-text p {
            color: var(--gris-medio);
            font-size: 0.95em;
            font-weight: 500;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--gris-claro);
            padding: 12px 22px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid rgba(13, 115, 57, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .connection-status:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .connection-status:active {
            transform: translateY(0);
        }
        
        .status-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--verde-medio);
            animation: pulse 2s infinite;
            box-shadow: 0 0 8px rgba(87, 166, 65, 0.5);
        }
        
        .status-dot.disconnected {
            background: var(--rojo);
            animation: none;
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.5);
        }
        
        .status-dot.connecting {
            background: var(--amarillo);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { 
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(87, 166, 65, 0.7);
            }
            70% { 
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(87, 166, 65, 0);
            }
            100% { 
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(87, 166, 65, 0);
            }
        }
        
        /* Panel principal */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }
        
        /* Tarjetas de estado */
        .card {
            background: var(--blanco);
            border-radius: var(--borde-radius);
            padding: 28px;
            box-shadow: var(--sombra);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(13, 115, 57, 0.1);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--verde-oscuro), var(--verde-medio));
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: var(--sombra-hover);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 22px;
            gap: 15px;
        }
        
        .card-icon {
            width: 55px;
            height: 55px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        
        .nivel-icon {
            background: linear-gradient(135deg, rgba(13, 115, 57, 0.15) 0%, rgba(87, 166, 65, 0.15) 100%);
            color: var(--verde-oscuro);
        }
        
        .tanque-icon {
            background: linear-gradient(135deg, rgba(87, 166, 65, 0.15) 0%, rgba(148, 191, 117, 0.15) 100%);
            color: var(--verde-acento);
        }
        
        .bomba-icon {
            background: linear-gradient(135deg, rgba(242, 204, 12, 0.15) 0%, rgba(255, 230, 120, 0.15) 100%);
            color: var(--amarillo-oscuro);
        }
        
        .card-title {
            font-size: 1.15em;
            color: var(--gris-oscuro);
            font-weight: 700;
        }
        
        .card-value {
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 15px;
            letter-spacing: -1px;
        }
        
        .nivel-value {
            color: var(--verde-oscuro);
        }
        
        .tanque-value {
            color: var(--verde-acento);
        }
        
        .bomba-value {
            color: var(--amarillo-oscuro);
        }
        
        .card-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 18px;
            padding-top: 18px;
            border-top: 1px solid rgba(0,0,0,0.08);
        }
        
        .card-label {
            font-size: 0.92em;
            color: var(--gris-medio);
            font-weight: 500;
        }
        
        /* Indicador de nivel */
        .nivel-indicator-container {
            margin-top: 20px;
            background: var(--gris-claro);
            border-radius: 12px;
            height: 16px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .nivel-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--verde-oscuro), var(--verde-medio));
            border-radius: 12px;
            transition: width 1.5s ease;
            width: 0%;
            position: relative;
            overflow: hidden;
        }
        
        .nivel-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Panel de control */
        .control-panel {
            background: var(--blanco);
            border-radius: var(--borde-radius);
            padding: 28px;
            box-shadow: var(--sombra);
            margin-top: 25px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(13, 115, 57, 0.1);
        }
        
        .control-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--verde-oscuro), var(--verde-medio));
        }
        
        .control-title {
            font-size: 1.35em;
            color: var(--verde-oscuro);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
        }
        
        .btn {
            padding: 18px 22px;
            border: none;
            border-radius: 12px;
            font-size: 1.05em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.2);
            transform: translateX(-100%);
            transition: transform 0.4s ease;
        }
        
        .btn:hover::after {
            transform: translateX(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1) !important;
        }
        
        .btn:disabled::after {
            display: none;
        }
        
        .btn-on {
            background: linear-gradient(135deg, var(--verde-medio) 0%, var(--verde-oscuro) 100%);
            color: var(--blanco);
        }
        
        .btn-on:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(87, 166, 65, 0.4);
        }
        
        .btn-off {
            background: linear-gradient(135deg, var(--amarillo) 0%, var(--amarillo-oscuro) 100%);
            color: var(--gris-oscuro);
        }
        
        .btn-off:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(242, 204, 12, 0.4);
        }
        
        .btn-auto {
            background: linear-gradient(135deg, var(--verde-claro) 0%, var(--verde-acento) 100%);
            color: var(--blanco);
        }
        
        .btn-auto:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(148, 191, 117, 0.4);
        }
        
        /* Sección de logs */
        .log-section {
            background: var(--blanco);
            border-radius: var(--borde-radius);
            padding: 28px;
            box-shadow: var(--sombra);
            margin-top: 25px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(13, 115, 57, 0.1);
        }
        
        .log-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--verde-oscuro), var(--verde-medio));
        }
        
        .log-title {
            font-size: 1.35em;
            color: var(--verde-oscuro);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
        }
        
        #logContainer {
            height: 220px;
            overflow-y: auto;
            background: var(--gris-claro);
            padding: 18px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.92em;
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding: 10px 14px;
            border-left: 4px solid var(--verde-medio);
            background: var(--blanco);
            border-radius: 0 8px 8px 0;
            animation: fadeIn 0.5s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            display: flex;
            align-items: center;
        }
        
        .log-entry.arduino {
            border-left-color: var(--verde-oscuro);
            background: var(--verde-muy-claro);
        }
        
        .log-entry.error {
            border-left-color: var(--rojo);
            background: rgba(231, 76, 60, 0.05);
        }
        
        .log-entry.warning {
            border-left-color: var(--amarillo);
            background: rgba(242, 204, 12, 0.05);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .timestamp {
            color: var(--verde-oscuro);
            font-weight: 700;
            margin-right: 12px;
            min-width: 80px;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 35px;
            padding: 22px;
            color: var(--blanco);
            opacity: 0.9;
            font-size: 0.95em;
            font-weight: 500;
        }
        
        /* Modal de ayuda */
        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .help-content {
            background: var(--blanco);
            padding: 30px;
            border-radius: var(--borde-radius);
            max-width: 500px;
            width: 90%;
            box-shadow: var(--sombra-hover);
        }
        
        .help-title {
            color: var(--verde-oscuro);
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .help-steps {
            margin-bottom: 25px;
        }
        
        .help-step {
            margin-bottom: 15px;
            padding-left: 25px;
            position: relative;
        }
        
        .help-step::before {
            content: '•';
            color: var(--verde-medio);
            font-size: 1.5em;
            position: absolute;
            left: 0;
            top: -5px;
        }
        
        .help-close {
            background: var(--verde-medio);
            color: var(--blanco);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            float: right;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 18px;
                text-align: center;
            }
            
            .logo-section {
                flex-direction: column;
            }
            
            .control-buttons {
                grid-template-columns: 1fr;
            }
            
            .card-value {
                font-size: 2.5em;
            }
            
            .btn {
                padding: 16px 20px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            
            .card {
                padding: 22px;
            }
            
            .control-panel, .log-section {
                padding: 22px;
            }
            
            .card-header {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }
            
            .card-footer {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header con logo -->
        <div class="header">
            <div class="logo-section">
                <div class="logo-placeholder">
                    <i class="fas fa-tint"></i>
                </div>
                <div class="logo-text">
                    <h1>NivelUPC</h1>
                    <p>Sistema Inteligente de Control de Nivel</p>
                </div>
            </div>
            <div class="connection-status" id="connectionStatus">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Conectar con Arduino</span>
            </div>
        </div>
        
        <div class="dashboard">
            <!-- Tarjeta de Nivel de Agua -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon nivel-icon">
                        <i class="fas fa-ruler-vertical"></i>
                    </div>
                    <div class="card-title">Nivel de Agua</div>
                </div>
                <div class="card-value nivel-value" id="nivelValue">--</div>
                <div class="nivel-indicator-container">
                    <div class="nivel-fill" id="nivelFill"></div>
                </div>
                <div class="card-footer">
                    <span class="card-label">Distancia medida por sensor</span>
                    <span class="card-label" id="nivelPorcentaje">--%</span>
                </div>
            </div>
            
            <!-- Tarjeta de Estado del Tanque -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon tanque-icon">
                        <i class="fas fa-water"></i>
                    </div>
                    <div class="card-title">Estado del Tanque</div>
                </div>
                <div class="card-value tanque-value" id="estadoValue">--</div>
                <div class="card-footer">
                    <span class="card-label">Estado actual del sistema</span>
                </div>
            </div>
            
            <!-- Tarjeta de Estado de la Bomba -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon bomba-icon">
                        <i class="fas fa-power-off"></i>
                    </div>
                    <div class="card-title">Estado de la Bomba</div>
                </div>
                <div class="card-value bomba-value" id="bombaValue">--</div>
                <div class="card-footer">
                    <span class="card-label">Bomba de agua</span>
                    <span class="card-label" id="modoValue">--</span>
                </div>
            </div>
        </div>
        
        <!-- Panel de control -->
        <div class="control-panel">
            <div class="control-title">
                <i class="fas fa-sliders-h"></i>
                Panel de Control
            </div>
            <div class="control-buttons">
                <button class="btn btn-on" id="btnEncender" onclick="controlBomba('ON')">
                    <i class="fas fa-play"></i> ENCENDER BOMBA
                </button>
                <button class="btn btn-off" id="btnApagar" onclick="controlBomba('OFF')">
                    <i class="fas fa-stop"></i> APAGAR BOMBA
                </button>
                <button class="btn btn-auto" id="btnAuto" onclick="controlBomba('AUTO')">
                    <i class="fas fa-robot"></i> MODO AUTOMÁTICO
                </button>
            </div>
        </div>
        
        <!-- Sección de logs -->
        <div class="log-section">
            <div class="log-title">
                <i class="fas fa-list-alt"></i>
                Registro de Eventos
            </div>
            <div id="logContainer"></div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>NivelUPC &copy; 2025 - Sistema Inteligente de Control de Nivel de Agua</p>
        </div>
    </div>

    <!-- Modal de ayuda para conexión -->
    <div class="help-modal" id="helpModal">
        <div class="help-content">
            <h2 class="help-title">Solución de Problemas de Conexión</h2>
            <div class="help-steps">
                <div class="help-step">Asegúrate de que el Arduino esté conectado por USB</div>
                <div class="help-step">Verifica que el cable USB funcione correctamente</div>
                <div class="help-step">En Windows, instala los drivers CH340 si usas Arduino clones</div>
                <div class="help-step">Cierra el Monitor Serial del IDE Arduino si está abierto</div>
                <div class="help-step">Usa Chrome o Edge como navegador</div>
                <div class="help-step">Selecciona el puerto correcto cuando el navegador lo solicite</div>
                <div class="help-step">Asegúrate de que el código Arduino esté cargado correctamente</div>
            </div>
            <button class="help-close" onclick="closeHelp()">Entendido</button>
        </div>
    </div>

<!-- Panel de control -->
<div class="control-panel">
    <div class="control-title">
        <i class="fas fa-sliders-h"></i> Panel de Control
    </div>
    <div class="control-buttons">
        <button class="btn btn-on" id="btnOn">
            <i class="fas fa-play"></i> Encender Bomba
        </button>
        <button class="btn btn-off" id="btnOff">
            <i class="fas fa-stop"></i> Apagar Bomba
        </button>
        <button class="btn btn-auto" id="btnAuto">
            <i class="fas fa-cogs"></i> Modo Automático
        </button>
    </div>
</div>

<!-- Sección de logs -->
<div class="log-section">
    <div class="log-title">
        <i class="fas fa-terminal"></i> Registro del Sistema
    </div>
    <div id="logContainer"></div>
</div>

<!-- Footer -->
<div class="footer">
    © 2025 NivelUPC - Sistema de Control de Nivel de Agua
</div>

<script>
const connectBtn = document.getElementById("connectionStatus");
const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");
const nivelValue = document.getElementById("nivelValue");
const nivelFill = document.getElementById("nivelFill");
const nivelPorcentaje = document.getElementById("nivelPorcentaje");
const estadoValue = document.getElementById("estadoValue");
const bombaValue = document.getElementById("bombaValue");
const btnOn = document.getElementById("btnOn");
const btnOff = document.getElementById("btnOff");
const btnAuto = document.getElementById("btnAuto");

let port, reader, outputStream;

// Conectar con Arduino
async function conectarArduino() {
  try {
    statusDot.className = "status-dot connecting";
    statusText.textContent = "Conectando...";
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 9600 });

    const decoder = new TextDecoderStream();
    const encoder = new TextEncoderStream();
    outputStream = encoder.writable;
    port.readable.pipeTo(decoder.writable);
    reader = decoder.readable.getReader();
    encoder.readable.pipeTo(port.writable);

    statusDot.className = "status-dot";
    statusText.textContent = "Conectado";
    log("✅ Conexión establecida con Arduino", "arduino");

    escucharDatos();
  } catch (err) {
    log("❌ Error al conectar: " + err.message, "error");
    statusDot.className = "status-dot disconnected";
    statusText.textContent = "Conectar con Arduino";
  }
}

// Escuchar datos del Arduino
async function escucharDatos() {
  try {
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      if (value) procesarLinea(value.trim());
    }
  } catch (error) {
    log("⚠ Error leyendo datos: " + error.message, "error");
  }
}

// Procesar cada línea recibida
function procesarLinea(linea) {
  log("→ " + linea, "arduino");
  if (linea.startsWith("DISTANCIA:")) {
    const partes = linea.split(",");
    const distancia = parseFloat(partes[0].split(":")[1]);
    const bomba = partes[1].split(":")[1];
    const modo = partes[2].split(":")[1];
    const estado = partes[3].split(":")[1];

    // Calcular porcentaje (ajusta a tu tanque)
    const porcentaje = Math.max(0, Math.min(100, 100 - ((distancia - 2) / (9 - 2)) * 100));

    nivelValue.textContent = distancia.toFixed(1) + " cm";
    nivelPorcentaje.textContent = porcentaje.toFixed(0) + "%";
    nivelFill.style.width = porcentaje + "%";
    estadoValue.textContent = estado;
    bombaValue.textContent = bomba;
  }
}

// Enviar comando al Arduino
async function enviarComando(cmd) {
  if (!outputStream) return log("⚠ No hay conexión activa", "warning");
  const writer = outputStream.getWriter();
  await writer.write(cmd + "\n");
  writer.releaseLock();
  log("← Enviado: " + cmd);
}

// Mostrar log
function log(texto, tipo = "") {
  const contenedor = document.getElementById("logContainer");
  const div = document.createElement("div");
  div.className = "log-entry " + tipo;
  const time = new Date().toLocaleTimeString();
  div.innerHTML = <span class="timestamp">${time}</span>${texto};
  contenedor.appendChild(div);
  contenedor.scrollTop = contenedor.scrollHeight;
}

// Eventos de botones
connectBtn.addEventListener("click", async () => {
  if (!port) await conectarArduino();
});

btnOn.addEventListener("click", () => enviarComando("BOMBA:ON"));
btnOff.addEventListener("click", () => enviarComando("BOMBA:OFF"));
btnAuto.addEventListener("click", () => enviarComando("MODO:AUTO"));

// Simulación si no hay Web Serial
if (!("serial" in navigator)) {
  log("⚠ Web Serial no soportado. Activando simulación.", "warning");
  let fakeNivel = 5;
  setInterval(() => {
    fakeNivel += (Math.random() - 0.5) * 2;
    fakeNivel = Math.max(2, Math.min(9, fakeNivel));
    procesarLinea(DISTANCIA:${fakeNivel.toFixed(1)},BOMBA:${fakeNivel > 7 ? "ON" : "OFF"},MODO:AUTO,ESTADO:${fakeNivel < 3 ? "LLENO" : fakeNivel > 7 ? "VACIO" : "NORMAL"});
  }, 1000);
}
</script>
</body>
</html>

