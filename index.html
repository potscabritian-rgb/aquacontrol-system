<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Nivel Calibrado</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d47a1;
            --primary-light: #e8f0fe;
            --success: #34a853;
            --success-light: #e6f4ea;
            --warning: #fbbc05;
            --warning-light: #fef7e0;
            --danger: #ea4335;
            --danger-light: #fce8e6;
            --gray-50: #f8f9fa;
            --gray-100: #f1f3f4;
            --gray-200: #e8eaed;
            --gray-300: #dadce0;
            --gray-600: #5f6368;
            --gray-800: #3c4043;
            --gray-900: #202124;
            --border-radius: 12px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #0D7339 0%, #57A641 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .contenedor {
            background: white;
            color: var(--gray-900);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-900);
        }
        
        .header p {
            font-size: 16px;
            color: var(--gray-600);
            font-weight: 400;
        }
        
        .estado {
            margin: 24px 0;
            padding: 16px;
            border-radius: var(--border-radius);
            font-weight: 500;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: var(--transition);
            cursor: pointer;
        }
        
        .estado.desconectado {
            background: var(--danger-light);
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        .estado.conectado {
            background: var(--success-light);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .calibracion-info {
            background: var(--primary-light);
            border: 1px solid var(--primary);
            padding: 20px;
            margin: 24px 0;
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        .calibracion-texto {
            font-size: 16px;
            font-weight: 500;
            color: var(--primary-dark);
            margin-bottom: 8px;
        }
        
        .calibracion-regla {
            font-size: 14px;
            color: var(--gray-600);
        }
        
        .panel-principal {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin: 32px 0;
        }
        
        .info-box {
            background: var(--gray-50);
            padding: 24px;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }
        
        .info-box h3 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 20px;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .valor-grande {
            font-size: 42px;
            font-weight: 600;
            margin: 16px 0;
        }
        
        .bomba-on {
            color: var(--success);
        }
        
        .bomba-off {
            color: var(--danger);
        }
        
        .barra-contenedor {
            margin: 24px 0;
        }
        
        .barra-nivel {
            width: 100%;
            height: 32px;
            background: var(--gray-200);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
        }
        
        .nivel-agua {
            height: 100%;
            background: linear-gradient(90deg, #1a73e8, #4285f4);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 16px;
        }
        
        .marcas-calibracion {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 8px;
        }
        
        .marca {
            position: relative;
            width: 1px;
            height: 100%;
            background: rgba(0,0,0,0.2);
        }
        
        .marca-texto {
            position: absolute;
            top: -24px;
            left: -15px;
            white-space: nowrap;
            font-size: 11px;
            font-weight: 500;
            color: var(--gray-600);
        }
        
        .porcentaje-grande {
            font-size: 48px;
            font-weight: 600;
            color: var(--primary);
            margin: 16px 0;
        }
        
        .info-box-footer {
            font-size: 14px;
            color: var(--gray-600);
            margin-top: 8px;
        }
        
        .control-bomba {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
        }
        
        .icono-bomba {
            font-size: 40px;
            margin: 16px 0;
        }
        
        .info-bomba {
            font-size: 14px;
            color: var(--gray-600);
            margin-top: 8px;
        }
        
        .botones-conexion {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin: 32px 0;
        }
        
        .boton {
            padding: 14px 28px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .boton-primario {
            background: var(--primary);
            color: white;
        }
        
        .boton-primario:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .boton-primario:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .boton-secundario {
            background: white;
            color: var(--gray-800);
            border: 1px solid var(--gray-300);
        }
        
        .boton-secundario:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }
        
        .boton-secundario:disabled {
            background: var(--gray-100);
            color: var(--gray-400);
            cursor: not-allowed;
        }

        .boton-control {
            padding: 12px 24px;
            margin: 5px;
            font-size: 14px;
        }

        .boton-success {
            background: var(--success);
            color: white;
        }

        .boton-danger {
            background: var(--danger);
            color: white;
        }

        .boton-warning {
            background: var(--warning);
            color: white;
        }

        .modo-control {
            background: var(--warning-light);
            border: 1px solid var(--warning);
            padding: 16px;
            margin: 16px 0;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .modo-texto {
            font-size: 16px;
            font-weight: 500;
            color: var(--gray-800);
            margin-bottom: 12px;
        }

        .controles-manuales {
            display: none;
            text-align: center;
            margin-top: 16px;
        }
        
        .logs {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            height: 200px;
            overflow-y: auto;
            text-align: left;
            padding: 20px;
            margin-top: 24px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 14px;
            border-radius: var(--border-radius);
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding: 10px;
            border-left: 3px solid var(--gray-300);
            background: white;
            border-radius: 4px;
        }
        
        .log-accion {
            border-left-color: var(--primary);
            background: var(--primary-light);
        }
        
        .log-error {
            border-left-color: var(--danger);
            background: var(--danger-light);
        }

        .log-warning {
            border-left-color: var(--warning);
            background: var(--warning-light);
        }
        
        /* Nuevos estilos para mejoras visuales */
        .contenedor-icono {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-light);
            margin-right: 10px;
        }
        
        .contenedor-icono i {
            color: var(--primary);
            font-size: 18px;
        }
        
        .estado-conexion {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .indicador-estado {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .indicador-conectado {
            background-color: var(--success);
            box-shadow: 0 0 8px var(--success);
        }
        
        .indicador-desconectado {
            background-color: var(--danger);
            box-shadow: 0 0 8px var(--danger);
        }
        
        .indicador-conectando {
            background-color: var(--warning);
            box-shadow: 0 0 8px var(--warning);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .tarjeta-datos {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .tarjeta-datos h4 {
            font-size: 16px;
            color: var(--gray-600);
            margin-bottom: 10px;
        }
        
        .tarjeta-datos .valor {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .tarjeta-datos .unidad {
            font-size: 14px;
            color: var(--gray-600);
            margin-left: 5px;
        }
        
        .tarjeta-datos .descripcion {
            font-size: 12px;
            color: var(--gray-600);
            margin-top: 5px;
        }
        
        .contenedor-tarjetas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .contenedor-barra {
            position: relative;
            margin: 20px 0;
        }
        
        .etiquetas-barra {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 12px;
            color: var(--gray-600);
        }
        
        .etiqueta-min {
            text-align: left;
        }
        
        .etiqueta-max {
            text-align: right;
        }
        
        .etiqueta-actual {
            text-align: center;
            font-weight: 600;
            color: var(--primary);
        }
        
        .seccion-control {
            margin-top: 30px;
            border-top: 1px solid var(--gray-200);
            padding-top: 20px;
        }
        
        .titulo-seccion {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .contenedor {
                padding: 24px;
            }
            
            .panel-principal {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .botones-conexion {
                flex-direction: column;
            }
            
            .contenedor-tarjetas {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="contenedor">
        <div class="header">
            <h1><i class="fas fa-tint"></i> Control de Nivel Calibrado</h1>
            <p>Sistema de monitoreo y control con calibraci√≥n precisa</p>
        </div>
        
        <div class="estado desconectado" id="estadoConexion">
            <div class="estado-conexion">
                <span class="indicador-estado indicador-desconectado"></span>
                <span>DESCONECTADO - Haz clic para conectar</span>
            </div>
        </div>
        
        <div class="calibracion-info">
            <div class="calibracion-texto">
                <i class="fas fa-ruler"></i> CALIBRACI√ìN: 12.0cm = 0% (Vac√≠o) ‚Ä¢ 3.5cm = 100% (Lleno)
            </div>
            <div class="calibracion-regla">
                <i class="fas fa-bolt"></i> REGLA: BOMBA ON si >3.5cm ‚Ä¢ BOMBA OFF si ‚â§3.5cm
            </div>
        </div>
        
        <div class="panel-principal" id="panelPrincipal" style="display: none;">
            <div class="info-box">
                <h3><i class="fas fa-chart-line"></i> Medici√≥n</h3>
                
                <div class="contenedor-tarjetas">
                    <div class="tarjeta-datos">
                        <h4>Distancia del sensor</h4>
                        <div class="valor" id="valorDistancia">--<span class="unidad">cm</span></div>
                        <div class="descripcion">Distancia medida por el sensor ultras√≥nico</div>
                    </div>
                    
                    <div class="tarjeta-datos">
                        <h4>Nivel de llenado</h4>
                        <div class="valor" id="valorPorcentaje">--<span class="unidad">%</span></div>
                        <div class="descripcion">Porcentaje calculado seg√∫n calibraci√≥n</div>
                    </div>
                </div>
                
                <div class="contenedor-barra">
                    <div class="barra-nivel">
                        <div class="nivel-agua" id="nivelAgua"></div>
                        <div class="marcas-calibracion">
                            <div class="marca" style="left: 0%">
                                <div class="marca-texto">12cm 0%</div>
                            </div>
                            <div class="marca" style="left: 23.5%">
                                <div class="marca-texto">10cm</div>
                            </div>
                            <div class="marca" style="left: 47%">
                                <div class="marca-texto">8cm</div>
                            </div>
                            <div class="marca" style="left: 70.5%">
                                <div class="marca-texto">6cm</div>
                            </div>
                            <div class="marca" style="left: 100%">
                                <div class="marca-texto">3.5cm 100%</div>
                            </div>
                        </div>
                    </div>
                    <div class="etiquetas-barra">
                        <div class="etiqueta-min">Vac√≠o (0%)</div>
                        <div class="etiqueta-actual" id="etiquetaActual">--%</div>
                        <div class="etiqueta-max">Lleno (100%)</div>
                    </div>
                </div>
            </div>
            
            <div class="info-box">
                <h3><i class="fas fa-cog"></i> Control Bomba</h3>
                
                <div class="contenedor-tarjetas">
                    <div class="tarjeta-datos">
                        <h4>Estado de la bomba</h4>
                        <div class="valor" id="estadoBomba">--</div>
                        <div class="descripcion">Estado actual del sistema</div>
                    </div>
                </div>
                
                <div class="control-bomba">
                    <div class="icono-bomba" id="iconoBomba">
                        <i class="fas fa-circle" style="color: #dadce0;"></i>
                    </div>
                    <div class="info-bomba" id="infoBomba">
                        Sistema desconectado
                    </div>

                    <div class="seccion-control">
                        <div class="titulo-seccion">
                            <i class="fas fa-sliders-h"></i> Modo de Control
                        </div>
                        
                        <div class="modo-control">
                            <div class="modo-texto" id="textoModo">Modo: AUTOM√ÅTICO</div>
                            <button class="boton boton-warning boton-control" id="botonCambiarModo" onclick="cambiarModo()">
                                <i class="fas fa-sync-alt"></i>
                                <span>Cambiar a MODO MANUAL</span>
                            </button>
                        </div>

                        <div class="controles-manuales" id="controlesManuales">
                            <button class="boton boton-success boton-control" onclick="controlManual('ON')">
                                <i class="fas fa-play"></i>
                                <span>Encender Bomba</span>
                            </button>
                            <button class="boton boton-danger boton-control" onclick="controlManual('OFF')">
                                <i class="fas fa-stop"></i>
                                <span>Apagar Bomba</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="botones-conexion">
            <button class="boton boton-primario" id="botonConectar" onclick="conectarArduino()">
                <i class="fas fa-plug"></i>
                <span>Conectar con Arduino</span>
            </button>
            
            <button class="boton boton-secundario" id="botonDesconectar" onclick="desconectarArduino()" disabled>
                <i class="fas fa-power-off"></i>
                <span>Desconectar</span>
            </button>
        </div>
        
        <div class="seccion-control">
            <div class="titulo-seccion">
                <i class="fas fa-clipboard-list"></i> Registro de Actividad
            </div>
            <div class="logs" id="logContainer">
                <div class="log-entry">Sistema listo. Haz clic en "Conectar con Arduino"</div>
                <div class="log-entry">Calibraci√≥n: 12cm = 0% vac√≠o, 3.5cm = 100% lleno</div>
            </div>
        </div>
    </div>

    <script>
        // Estado del sistema calibrado
        let estado = {
            conectado: false,
            puerto: null,
            escritor: null,
            lector: null,
            distancia: 0,
            porcentaje: 0,
            bombaEncendida: false,
            modoManual: false,
            bufferDatos: '',
            
            // Configuraci√≥n de calibraci√≥n
            calibracion: {
                VACIO: 12.0,   // 12cm = 0%
                LLENO: 3.5     // 3.5cm = 100%
            }
        };

        // Elementos DOM
        const estadoConexion = document.getElementById('estadoConexion');
        const panelPrincipal = document.getElementById('panelPrincipal');
        const valorDistancia = document.getElementById('valorDistancia');
        const valorPorcentaje = document.getElementById('valorPorcentaje');
        const estadoBomba = document.getElementById('estadoBomba');
        const iconoBomba = document.getElementById('iconoBomba');
        const infoBomba = document.getElementById('infoBomba');
        const nivelAgua = document.getElementById('nivelAgua');
        const botonConectar = document.getElementById('botonConectar');
        const botonDesconectar = document.getElementById('botonDesconectar');
        const logContainer = document.getElementById('logContainer');
        const botonCambiarModo = document.getElementById('botonCambiarModo');
        const textoModo = document.getElementById('textoModo');
        const controlesManuales = document.getElementById('controlesManuales');
        const etiquetaActual = document.getElementById('etiquetaActual');

        // Funci√≥n para calcular porcentaje (igual que en Arduino para consistencia)
        function calcularPorcentaje(distancia) {
            const VACIO = estado.calibracion.VACIO;
            const LLENO = estado.calibracion.LLENO;
            
            if (distancia >= VACIO) {
                return 0;
            } else if (distancia <= LLENO) {
                return 100;
            } else {
                const rangoTotal = VACIO - LLENO;
                const distanciaDesdeVacio = VACIO - distancia;
                const porcentaje = (distanciaDesdeVacio / rangoTotal) * 100;
                return Math.max(0, Math.min(100, Math.round(porcentaje)));
            }
        }

        // Funci√≥n para agregar logs
        function agregarLog(mensaje, tipo = 'normal') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = tipo === 'accion' ? 'log-entry log-accion' : 
                                tipo === 'error' ? 'log-entry log-error' : 
                                tipo === 'warning' ? 'log-entry log-warning' : 'log-entry';
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${mensaje}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Funci√≥n para actualizar la UI
        function actualizarUI() {
            if (estado.conectado) {
                estadoConexion.innerHTML = '<div class="estado-conexion"><span class="indicador-estado indicador-conectado"></span><span>CONECTADO - Sistema calibrado activo</span></div>';
                estadoConexion.className = 'estado conectado';
                panelPrincipal.style.display = 'grid';
                botonConectar.disabled = true;
                botonDesconectar.disabled = false;
                
                // Actualizar interfaz seg√∫n el modo
                actualizarInterfazModo();
            } else {
                estadoConexion.innerHTML = '<div class="estado-conexion"><span class="indicador-estado indicador-desconectado"></span><span>DESCONECTADO - Haz clic para conectar</span></div>';
                estadoConexion.className = 'estado desconectado';
                panelPrincipal.style.display = 'none';
                botonConectar.disabled = false;
                botonDesconectar.disabled = true;
            }
        }

        // Funci√≥n para actualizar interfaz seg√∫n el modo
        function actualizarInterfazModo() {
            if (estado.modoManual) {
                textoModo.textContent = 'Modo: MANUAL';
                botonCambiarModo.innerHTML = '<i class="fas fa-sync-alt"></i><span>Cambiar a MODO AUTOM√ÅTICO</span>';
                controlesManuales.style.display = 'block';
                infoBomba.textContent = 'Control manual activo';
                infoBomba.style.color = '#fbbc05';
            } else {
                textoModo.textContent = 'Modo: AUTOM√ÅTICO';
                botonCambiarModo.innerHTML = '<i class="fas fa-sync-alt"></i><span>Cambiar a MODO MANUAL</span>';
                controlesManuales.style.display = 'none';
                infoBomba.textContent = 'Control autom√°tico activo';
                infoBomba.style.color = '#5f6368';
            }
        }

        // Funci√≥n para cambiar entre modo manual y autom√°tico
        async function cambiarModo() {
            if (!estado.conectado || !estado.escritor) {
                agregarLog('Error: No hay conexi√≥n con Arduino', 'error');
                return;
            }

            estado.modoManual = !estado.modoManual;
            
            try {
                const comando = estado.modoManual ? 'MODO:MANUAL\n' : 'MODO:AUTO\n';
                await estado.escritor.write(new TextEncoder().encode(comando));
                
                if (estado.modoManual) {
                    agregarLog('Modo cambiado a MANUAL - Control autom√°tico desactivado', 'warning');
                } else {
                    agregarLog('Modo cambiado a AUTOM√ÅTICO - Control autom√°tico activado', 'accion');
                }
                
                actualizarInterfazModo();
            } catch (error) {
                agregarLog(`Error al cambiar modo: ${error.message}`, 'error');
            }
        }

        // Funci√≥n para control manual de la bomba
        async function controlManual(accion) {
            if (!estado.conectado || !estado.escritor) {
                agregarLog('Error: No hay conexi√≥n con Arduino', 'error');
                return;
            }

            if (!estado.modoManual) {
                agregarLog('Error: El control manual solo est√° disponible en modo MANUAL', 'error');
                return;
            }

            try {
                const comando = `BOMBA:${accion}\n`;
                await estado.escritor.write(new TextEncoder().encode(comando));
                agregarLog(`Comando manual enviado: BOMBA ${accion}`, 'accion');
            } catch (error) {
                agregarLog(`Error al enviar comando manual: ${error.message}`, 'error');
            }
        }

        // Funci√≥n para actualizar los datos del sensor
        function actualizarDatosSensor(distancia, bombaEstado, porcentajeRecibido, modoArduino) {
            estado.distancia = distancia;
            estado.bombaEncendida = bombaEstado;
            
            // Sincronizar modo con Arduino si se recibe
            if (modoArduino !== undefined) {
                estado.modoManual = modoArduino;
                actualizarInterfazModo();
            }
            
            // Calcular o usar el porcentaje recibido
            if (porcentajeRecibido !== undefined) {
                estado.porcentaje = porcentajeRecibido;
            } else {
                estado.porcentaje = calcularPorcentaje(distancia);
            }
            
            // Mostrar distancia
            valorDistancia.innerHTML = distancia.toFixed(1) + '<span class="unidad">cm</span>';
            
            // Mostrar porcentaje
            valorPorcentaje.innerHTML = estado.porcentaje + '<span class="unidad">%</span>';
            etiquetaActual.textContent = estado.porcentaje + '%';
            
            // Actualizar barra de nivel con el porcentaje calibrado
            nivelAgua.style.width = estado.porcentaje + '%';
            
            // Actualizar estado de la bomba
            if (bombaEstado) {
                estadoBomba.textContent = 'ENCENDIDA';
                estadoBomba.style.color = '#34a853';
                iconoBomba.innerHTML = '<i class="fas fa-circle" style="color: #34a853;"></i>';
                iconoBomba.title = 'Bomba encendida - Llenando tanque';
            } else {
                estadoBomba.textContent = 'APAGADA';
                estadoBomba.style.color = '#ea4335';
                iconoBomba.innerHTML = '<i class="fas fa-circle" style="color: #ea4335;"></i>';
                iconoBomba.title = 'Bomba apagada - Tanque lleno';
            }
            
            // Actualizar info seg√∫n modo
            if (estado.modoManual) {
                infoBomba.textContent = 'Control manual activo';
                infoBomba.style.color = '#fbbc05';
            } else {
                infoBomba.textContent = bombaEstado ? 'Llenando tanque...' : 'Tanque lleno';
                infoBomba.style.color = bombaEstado ? '#34a853' : '#ea4335';
            }
        }

        // Funci√≥n principal para conectar
        async function conectarArduino() {
            agregarLog('Iniciando conexi√≥n con Arduino...');
            
            try {
                if (!('serial' in navigator)) {
                    throw new Error('Web Serial API no soportada. Usa Chrome o Edge.');
                }

                estadoConexion.innerHTML = '<div class="estado-conexion"><span class="indicador-estado indicador-conectando"></span><span>CONECTANDO...</span></div>';
                estadoConexion.className = 'estado conectado';

                // Solicitar y abrir puerto
                estado.puerto = await navigator.serial.requestPort();
                agregarLog('Puerto seleccionado');

                await estado.puerto.open({ 
                    baudRate: 9600,
                    dataBits: 8,
                    stopBits: 1,
                    parity: 'none'
                });
                agregarLog('Puerto abierto exitosamente');

                // Configurar escritor y lector
                estado.escritor = estado.puerto.writable.getWriter();
                const textDecoder = new TextDecoderStream();
                const readableStreamClosed = estado.puerto.readable.pipeTo(textDecoder.writable);
                estado.lector = textDecoder.readable.getReader();

                // Marcar como conectado
                estado.conectado = true;
                estado.bufferDatos = '';
                estado.modoManual = false; // Iniciar en modo autom√°tico
                agregarLog('‚úÖ CONEXI√ìN EXITOSA con Arduino');
                agregarLog('Sistema calibrado activado - Modo AUTOM√ÅTICO');

                // Iniciar lectura de datos
                leerDatosArduino();

            } catch (error) {
                agregarLog(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                estado.conectado = false;
            }

            actualizarUI();
        }

        // Funci√≥n para leer datos del Arduino
        async function leerDatosArduino() {
            try {
                agregarLog('Leyendo datos calibrados del sensor...');
                
                while (estado.conectado && estado.lector) {
                    const { value, done } = await estado.lector.read();
                    
                    if (done) {
                        agregarLog('Conexi√≥n cerrada por el Arduino');
                        break;
                    }
                    
                    if (value) {
                        procesarDatosRecibidos(value);
                    }
                }
            } catch (error) {
                agregarLog(`Error leyendo datos: ${error.message}`, 'error');
                estado.conectado = false;
                actualizarUI();
            }
        }

        // Funci√≥n para procesar datos recibidos
        function procesarDatosRecibidos(datos) {
            estado.bufferDatos += datos;
            const lineas = estado.bufferDatos.split('\n');
            estado.bufferDatos = lineas.pop() || '';
            
            lineas.forEach(linea => {
                linea = linea.trim();
                if (!linea) return;
                
                // Procesar datos en formato: DISTANCIA:9.35,BOMBA:OFF,PORCENTAJE:45,MODO:AUTO
                if (linea.includes('DISTANCIA:') && linea.includes('BOMBA:') && linea.includes('PORCENTAJE:')) {
                    const partes = linea.split(',');
                    let distancia = 0;
                    let bombaEstado = false;
                    let porcentaje = 0;
                    let modoArduino = false;
                    
                    partes.forEach(parte => {
                        if (parte.startsWith('DISTANCIA:')) {
                            distancia = parseFloat(parte.substring(10));
                        } else if (parte.startsWith('BOMBA:')) {
                            bombaEstado = parte.substring(6) === 'ON';
                        } else if (parte.startsWith('PORCENTAJE:')) {
                            porcentaje = parseInt(parte.substring(11));
                        } else if (parte.startsWith('MODO:')) {
                            modoArduino = parte.substring(5) === 'MANUAL';
                        }
                    });
                    
                    if (!isNaN(distancia)) {
                        actualizarDatosSensor(distancia, bombaEstado, porcentaje, modoArduino);
                    }
                    
                } else if (linea.startsWith('ACCION:')) {
                    agregarLog(`‚ö° ${linea.substring(7)}`, 'accion');
                } else if (linea === 'SISTEMA_CALIBRADO_INICIADO') {
                    agregarLog('‚úÖ Sistema calibrado iniciado', 'accion');
                } else if (linea.includes('CALIBRACION:')) {
                    agregarLog(`üìè ${linea}`, 'accion');
                } else if (linea.includes('REGLA:')) {
                    agregarLog(`‚ö° ${linea}`, 'accion');
                } else if (linea.includes('MODO_CAMBIADO:')) {
                    agregarLog(`üîÑ ${linea.substring(14)}`, 'warning');
                } else if (linea.includes('MANUAL:')) {
                    agregarLog(`üéÆ ${linea.substring(7)}`, 'accion');
                } else {
                    agregarLog(`üì® ${linea}`);
                }
            });
        }

        // Funci√≥n para desconectar
        async function desconectarArduino() {
            agregarLog('Desconectando...');
            
            try {
                if (estado.lector) await estado.lector.cancel();
                if (estado.escritor) await estado.escritor.close();
                if (estado.puerto) await estado.puerto.close();
                
                agregarLog('Desconexi√≥n completada');
            } catch (error) {
                agregarLog(`Error al desconectar: ${error.message}`, 'error');
            }
            
            estado.conectado = false;
            estado.distancia = 0;
            estado.porcentaje = 0;
            estado.bombaEncendida = false;
            estado.modoManual = false;
            estado.bufferDatos = '';
            actualizarUI();
        }

        // Inicializar
        actualizarUI();
        agregarLog('Sistema de control calibrado listo');
        agregarLog('Calibraci√≥n: 12cm = 0% vac√≠o, 3.5cm = 100% lleno');
    </script>
</body>
</html>
