<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Nivel - Sistema Estable</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Tus estilos CSS existentes aquí */
        /* ... (mantener todos los estilos anteriores) ... */
        
        .estado-error {
            background: var(--danger-light);
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        .reconectar-boton {
            margin-top: 10px;
            padding: 8px 16px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="contenedor">
        <!-- Tu HTML existente aquí -->
        <!-- ... (mantener todo el HTML anterior) ... -->
    </div>

    <script>
        // Estado del sistema calibrado
        let estado = {
            conectado: false,
            puerto: null,
            escritor: null,
            lector: null,
            distancia: 0,
            porcentaje: 0,
            bombaLlenadoEncendida: false,
            bombaVaciadoEncendida: false,
            modoManual: false,
            bufferDatos: '',
            intentandoReconectar: false,
            tiempoUltimoDato: 0,
            
            // Configuración de calibración
            calibracion: {
                VACIO: 12.0,
                LLENO: 3.5
            }
        };

        // Elementos DOM (mantener los existentes)
        // ...

        // Función mejorada para conectar con Arduino
        async function conectarArduino() {
            if (estado.intentandoReconectar) return;
            
            agregarLog('Iniciando conexión con Arduino...');
            
            try {
                if (!('serial' in navigator)) {
                    throw new Error('Web Serial API no soportada. Usa Chrome o Edge.');
                }

                estadoConexion.innerHTML = '<div class="estado-conexion"><span class="indicador-estado indicador-conectando"></span><span>CONECTANDO...</span></div>';
                estadoConexion.className = 'estado conectado';

                // Solicitar y abrir puerto
                estado.puerto = await navigator.serial.requestPort();
                agregarLog('Puerto seleccionado');

                await estado.puerto.open({ 
                    baudRate: 9600,
                    dataBits: 8,
                    stopBits: 1,
                    parity: 'none'
                });
                agregarLog('Puerto abierto exitosamente');

                // Configurar escritor y lector
                estado.escritor = estado.puerto.writable.getWriter();
                const textDecoder = new TextDecoderStream();
                const readableStreamClosed = estado.puerto.readable.pipeTo(textDecoder.writable);
                estado.lector = textDecoder.readable.getReader();

                // Marcar como conectado
                estado.conectado = true;
                estado.bufferDatos = '';
                estado.modoManual = false;
                estado.tiempoUltimoDato = Date.now();
                estado.intentandoReconectar = false;
                
                agregarLog('✅ CONEXIÓN EXITOSA con Arduino', 'accion');
                agregarLog('Sistema estable - Modo AUTOMÁTICO');

                // Configurar detección de desconexión
                estado.puerto.addEventListener('disconnect', () => {
                    manejarDesconexion('Arduino desconectado físicamente');
                });

                // Iniciar monitoreo de conexión
                iniciarMonitoreoConexion();
                
                // Iniciar lectura de datos
                leerDatosArduino();

            } catch (error) {
                agregarLog(`❌ Error de conexión: ${error.message}`, 'error');
                estado.conectado = false;
                estado.intentandoReconectar = false;
                mostrarBotonReconexion();
            }

            actualizarUI();
        }

        // Función para monitorear la conexión
        function iniciarMonitoreoConexion() {
            setInterval(() => {
                if (estado.conectado) {
                    const tiempoSinDatos = Date.now() - estado.tiempoUltimoDato;
                    // Si pasan más de 5 segundos sin datos, considerar desconectado
                    if (tiempoSinDatos > 5000) {
                        manejarDesconexion('Timeout - Sin datos del Arduino');
                    }
                }
            }, 1000);
        }

        // Función mejorada para manejar desconexiones
        function manejarDesconexion(razon) {
            if (!estado.conectado) return;
            
            agregarLog(`⚠️ Desconexión detectada: ${razon}`, 'warning');
            estado.conectado = false;
            
            // Intentar limpiar recursos
            try {
                if (estado.lector) {
                    estado.lector.cancel().catch(() => {});
                }
                if (estado.escritor) {
                    estado.escritor.close().catch(() => {});
                }
                if (estado.puerto) {
                    estado.puerto.close().catch(() => {});
                }
            } catch (error) {
                console.log('Error limpiando recursos:', error);
            }
            
            estado.lector = null;
            estado.escritor = null;
            estado.puerto = null;
            
            actualizarUI();
            mostrarBotonReconexion();
        }

        // Función para mostrar botón de reconexión
        function mostrarBotonReconexion() {
            estadoConexion.innerHTML = `
                <div class="estado-conexion">
                    <span class="indicador-estado indicador-desconectado"></span>
                    <span>DESCONECTADO - ${estado.intentandoReconectar ? 'Reconectando...' : 'Error de conexión'}</span>
                </div>
                ${!estado.intentandoReconectar ? 
                    '<button class="boton boton-primario reconectar-boton" onclick="reconectarArduino()">Reconectar</button>' : 
                    ''}
            `;
            estadoConexion.className = 'estado estado-error';
        }

        // Función para reconectar automáticamente
        async function reconectarArduino() {
            estado.intentandoReconectar = true;
            mostrarBotonReconexion();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await conectarArduino();
        }

        // Función mejorada para leer datos
        async function leerDatosArduino() {
            try {
                while (estado.conectado && estado.lector) {
                    const { value, done } = await estado.lector.read();
                    
                    if (done) {
                        manejarDesconexion('Conexión cerrada por el Arduino');
                        break;
                    }
                    
                    if (value) {
                        estado.tiempoUltimoDato = Date.now();
                        procesarDatosRecibidos(value);
                    }
                }
            } catch (error) {
                if (estado.conectado) {
                    agregarLog(`Error leyendo datos: ${error.message}`, 'error');
                    manejarDesconexion('Error de lectura');
                }
            }
        }

        // Función mejorada para control manual con confirmación
        async function controlManual(accion) {
            if (!estado.conectado || !estado.escritor) {
                agregarLog('Error: No hay conexión con Arduino', 'error');
                return;
            }

            if (!estado.modoManual) {
                agregarLog('Error: El control manual solo está disponible en modo MANUAL', 'error');
                return;
            }

            try {
                // Pequeña pausa antes de enviar comando
                await new Promise(resolve => setTimeout(resolve, 50));
                
                const comando = `BOMBA:${accion}\n`;
                await estado.escritor.write(new TextEncoder().encode(comando));
                agregarLog(`Comando enviado: ${accion}`, 'accion');
                
                // Pequeña pausa después de enviar comando
                await new Promise(resolve => setTimeout(resolve, 100));
                
            } catch (error) {
                agregarLog(`Error al enviar comando: ${error.message}`, 'error');
                manejarDesconexion('Error de escritura');
            }
        }

        // Resto de tus funciones JavaScript...
        // ... (mantener las demás funciones)

        // Inicializar
        actualizarUI();
        agregarLog('Sistema de control mejorado listo');
        agregarLog('Protecciones activadas contra picos de corriente');
    </script>
</body>
</html>
