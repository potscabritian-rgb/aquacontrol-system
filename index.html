const int trigPin = 9;
const int echoPin = 10;
const int relayLlenado = 8;
const int relayVaciado = 7;

const float TANQUE_LLENO = 3.5;
const float TANQUE_VACIO = 12.0;

bool bombaLlenadoEncendida = false;
bool bombaVaciadoEncendida = false;
bool modoManual = false;
String comandoSerial = "";

void setup() {
  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
  pinMode(relayLlenado, OUTPUT);
  pinMode(relayVaciado, OUTPUT);

  digitalWrite(relayLlenado, LOW);
  digitalWrite(relayVaciado, LOW);
  bombaLlenadoEncendida = false;
  bombaVaciadoEncendida = false;
  modoManual = false;

  Serial.begin(9600);
  while (!Serial) {}
  delay(2000);
  Serial.println("SISTEMA_CALIBRADO_INICIADO");
  Serial.println("CALIBRACION: 12.0cm=0%, 3.5cm=100%");
  Serial.println("REGLA: BOMBA LLENADO ON si >3.5cm, OFF si <=3.5cm");
  Serial.println("MODO: AUTO - Control automático activado");
}

void loop() {
  procesarComandosSerial();
  float distancia = medirDistancia();

  if (!modoManual) {
    controlAutomatico(distancia);
  }

  int porcentaje = calcularPorcentaje(distancia);

  Serial.print("DISTANCIA:");
  Serial.print(distancia, 2);
  Serial.print(",BOMBA_LLENADO:");
  Serial.print(bombaLlenadoEncendida ? "ON" : "OFF");
  Serial.print(",BOMBA_VACIADO:");
  Serial.print(bombaVaciadoEncendida ? "ON" : "OFF");
  Serial.print(",PORCENTAJE:");
  Serial.print(porcentaje);
  Serial.print(",MODO:");
  Serial.println(modoManual ? "MANUAL" : "AUTO");

  delay(1000);
}

void procesarComandosSerial() {
  while (Serial.available() > 0) {
    char c = Serial.read();

    if (c == '\n') {
      comandoSerial.trim();

      if (comandoSerial == "MODO:MANUAL") {
        modoManual = true;
        Serial.println("MODO_CAMBIADO: MANUAL - Control automático desactivado");
        Serial.println("MANUAL: Use BOMBA:LLENADO_ON/OFF o BOMBA:VACIADO_ON/OFF para control manual");

      } else if (comandoSerial == "MODO:AUTO") {
        modoManual = false;
        Serial.println("MODO_CAMBIADO: AUTOMÁTICO - Control automático activado");

      } else if (comandoSerial == "BOMBA:LLENADO_ON") {
        if (modoManual) {
          digitalWrite(relayLlenado, HIGH);
          bombaLlenadoEncendida = true;
          Serial.println("MANUAL: Bomba de llenado encendida por comando");
          Serial.println("ACCION: BOMBA_LLENADO_ENCENDIDA_MANUAL");
        } else {
          Serial.println("MANUAL: Comando ignorado - Modo automático activo");
        }

      } else if (comandoSerial == "BOMBA:LLENADO_OFF") {
        if (modoManual) {
          digitalWrite(relayLlenado, LOW);
          bombaLlenadoEncendida = false;
          Serial.println("MANUAL: Bomba de llenado apagada por comando");
          Serial.println("ACCION: BOMBA_LLENADO_APAGADA_MANUAL");
        } else {
          Serial.println("MANUAL: Comando ignorado - Modo automático activo");
        }
        
      } else if (comandoSerial == "BOMBA:VACIADO_ON") {
        if (modoManual) {
          digitalWrite(relayVaciado, HIGH);
          bombaVaciadoEncendida = true;
          Serial.println("MANUAL: Bomba de vaciado encendida por comando");
          Serial.println("ACCION: BOMBA_VACIADO_ENCENDIDA_MANUAL");
        } else {
          Serial.println("MANUAL: Comando ignorado - Modo automático activo");
        }

      } else if (comandoSerial == "BOMBA:VACIADO_OFF") {
        if (modoManual) {
          digitalWrite(relayVaciado, LOW);
          bombaVaciadoEncendida = false;
          Serial.println("MANUAL: Bomba de vaciado apagada por comando");
          Serial.println("ACCION: BOMBA_VACIADO_APAGADA_MANUAL");
        } else {
          Serial.println("MANUAL: Comando ignorado - Modo automático activo");
        }
      }

      comandoSerial = "";
    } else {
      comandoSerial += c;
    }
  }
}

float medirDistancia() {
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  long duracion = pulseIn(echoPin, HIGH, 30000);

  if (duracion > 0) {
    float distancia = duracion * 0.034 / 2;
    if (distancia >= 2.0 && distancia <= 400.0) {
      return distancia;
    }
  }

  return 0.0;
}

int calcularPorcentaje(float distancia) {
  if (distancia >= TANQUE_VACIO) {
    return 0;
  } else if (distancia <= TANQUE_LLENO) {
    return 100;
  } else {
    float rangoTotal = TANQUE_VACIO - TANQUE_LLENO;
    float distanciaDesdeVacio = TANQUE_VACIO - distancia;
    float porcentaje = (distanciaDesdeVacio / rangoTotal) * 100.0;
    return constrain((int)porcentaje, 0, 100);
  }
}

void controlAutomatico(float distancia) {
  // Control de bomba de llenado
  if (distancia > TANQUE_LLENO && !bombaLlenadoEncendida && !bombaVaciadoEncendida) {
    digitalWrite(relayLlenado, HIGH);
    bombaLlenadoEncendida = true;
    Serial.println("ACCION: BOMBA_LLENADO_ENCENDIDA (tanque no lleno)");

  } else if (distancia <= TANQUE_LLENO && bombaLlenadoEncendida) {
    digitalWrite(relayLlenado, LOW);
    bombaLlenadoEncendida = false;
    Serial.println("ACCION: BOMBA_LLENADO_APAGADA (tanque lleno)");
  }
  
  // Control de bomba de vaciado (opcional - se puede activar manualmente o con otro criterio)
  // Por ejemplo, vaciar cuando se presiona un botón o cuando se alcanza cierto nivel
  // En este ejemplo, la bomba de vaciado solo se controla manualmente
}
